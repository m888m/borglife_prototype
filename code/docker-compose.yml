version: '3.8'

services:
  # BorgLife Services
  borglife-ui:
    build: .
    ports:
      - "8501:8501"
    environment:
      - BORGLIFE_UI_PORT=8501
      - ARCHON_SERVER_URL=http://host.docker.internal:8181
      - ARCHON_MCP_URL=http://host.docker.internal:8051
      - ARCHON_AGENTS_URL=http://host.docker.internal:8052
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - JAM_MOCK_MODE=true
    depends_on:
      - archon-server
      - archon-mcp
      - archon-agents
    volumes:
      - ./borg_dna.yaml:/app/borg_dna.yaml:ro
    command: streamlit run borg_designer_ui.py --server.port 8501 --server.address 0.0.0.0
    networks:
      - borglife-network

  borglife-mcp:
    build: .
    ports:
      - "8053:8053"
    environment:
      - BORGLIFE_MCP_PORT=8053
      - ARCHON_SERVER_URL=http://host.docker.internal:8181
      - ARCHON_MCP_URL=http://host.docker.internal:8051
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
    depends_on:
      - archon-server
      - archon-mcp
    networks:
      - borglife-network

  borglife-agent:
    build: .
    ports:
      - "8054:8054"
    environment:
      - BORGLIFE_AGENT_PORT=8054
      - ARCHON_AGENTS_URL=http://host.docker.internal:8052
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - archon-agents
    networks:
      - borglife-network

  # Archon Services (external - commented out)
  # archon-server:
  #   image: archon/server:latest
  #   ports:
  #     - "8181:8181"
  #   environment:
  #     - SUPABASE_URL=${ARCHON_SUPABASE_URL:-${SUPABASE_URL}}
  #     - SUPABASE_SERVICE_KEY=${ARCHON_SUPABASE_SERVICE_KEY:-${SUPABASE_SERVICE_KEY}}
  #     - OPENAI_API_KEY=${OPENAI_API_KEY}
  #   volumes:
  #     - archon_data:/app/data
  #   networks:
  #     - borglife-network
  #
  # archon-mcp:
  #   image: archon/mcp:latest
  #   ports:
  #     - "8051:8051"
  #   environment:
  #     - SUPABASE_URL=${ARCHON_SUPABASE_URL:-${SUPABASE_URL}}
  #     - SUPABASE_SERVICE_KEY=${ARCHON_SUPABASE_SERVICE_KEY:-${SUPABASE_SERVICE_KEY}}
  #   # depends_on:
  #   #   - archon-server
  #   networks:
  #     - borglife-network
  #
  # archon-agents:
  #   image: archon/agents:latest
  #   ports:
  #     - "8052:8052"
  #   environment:
  #     - SUPABASE_URL=${ARCHON_SUPABASE_URL:-${SUPABASE_URL}}
  #     - SUPABASE_SERVICE_KEY=${ARCHON_SUPABASE_SERVICE_KEY:-${SUPABASE_SERVICE_KEY}}
  #     - OPENAI_API_KEY=${OPENAI_API_KEY}
  #   # depends_on:
  #   #   - archon-server
  #   networks:
  #     - borglife-network

  # Docker MCP Organs (subset for Phase 1)
  docker-mcp-gmail:
    image: mcp/gmail:latest
    ports:
      - "8081:8080"
    environment:
      - MCP_TOOL=gmail
      - GMAIL_CREDENTIALS=${GMAIL_CREDENTIALS}
    networks:
      - borglife-network
    profiles:
      - organs

  docker-mcp-stripe:
    image: mcp/stripe:latest
    ports:
      - "8082:8080"
    environment:
      - MCP_TOOL=stripe
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
    networks:
      - borglife-network
    profiles:
      - organs

  docker-mcp-mongodb:
    image: mcp/mongodb:latest
    ports:
      - "8083:8080"
    environment:
      - MCP_TOOL=mongodb
      - MONGODB_CONNECTION_STRING=${MONGODB_CONNECTION_STRING}
    networks:
      - borglife-network
    profiles:
      - organs

  docker-mcp-duckduckgo:
    image: mcp/duckduckgo:latest
    ports:
      - "8084:8080"
    environment:
      - MCP_TOOL=duckduckgo
    networks:
      - borglife-network
    profiles:
      - organs

  # Redis for caching and rate limiting
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - borglife-network

  # PostgreSQL for local development (if not using Supabase)
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=borglife
      - POSTGRES_USER=borglife
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-borglife_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - borglife-network
    profiles:
      - local-db

networks:
  borglife-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  archon_data:
  redis_data:
  postgres_data:
